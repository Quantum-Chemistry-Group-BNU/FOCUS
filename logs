
=== FOCUS: FermiOniC qUantum Simulation ===

   Started by Zhendong Li @ Sep 14, 2019

### 2021 Initial (TR)DMRG implementation ###

 * Setup tests for NR & R integrals [DONE@2021/03/24]
 
 * Redesign and decouple codes [DONE@2021/04/08]
    
 * Implementation of CTNS with TRS [DONE@2021/05/16]
    - checked for kinds {rN,rNSz,cN,cNSz,cNK}
    - rewrite qtensor such that qt2/qt3/qt4 are just views

 * Parallelization: MPI [DONE@2021/05/30]
    - cleanup (IO) 
    - setup testing mechanism? 
    - preparation: makefile -> mpi 
    - mpi version 
       - distribute AP & BQ, compxwf, Hmat 
       - opt: HDiag, HVec, Davidson, pRDM, rwfuns, twodot 
       - load balance: adjust distribution
       - careful check serial/parallel version against previous 
         versions with different compilers

 * Benchmark performances: Fe2S2 [DONE@2021/08/11]
    - different topologies: -> SVD-based decimation
       - problem: TRS-adapted SVD decimation is necessary in initialization 
       - problem: decimation in sweep -> have to give up perturbative noise for CTNS! 
		   - decimation_row_nkr 
		   - decimation_row_kr 

 * Optimized parallel version: [DONE@2021/10/02]
    - OpenMP support 
 	 - Hx & decimation
	 - Initialization of CTNS
    - Z2 symmetry: {rZ2,cZ2}
        - Checked by diagonalizing fock::Hmat
    - better data structure for qtensor & oper_dict 
        - problem: can bypass the 2GB limit in MPI_COUNT using native MPI support (later)

### 2022 Optimized DMRG[CPU] algorithms ###

 * Optimized algorithms: symbolic algorithm [DONE@2022/04/02]
    - onedot algorithm:
    	- generation of onedot_Hx formulae
    	- implemenation of onedot_Hx contraction 
	   - adjoint of Hterm is treated in symbolic_onedot_Hx
	   - implementation of Kramers version of Hx 
	   - different treatment of Hl,Hcr,{CS/SC,AP,BQ}
    - twodot algorithm:
    	- generation of twodot_Hx formulae 
    	- optimized formation of sigma vector 
      - contract_qt4_qt2 (without intermediate/reshaping)
    - renormalization algorithm:
	 - generation of formulae 
         - optimized renormalization 
    - generation of formula: 
        - onedot/twodot-ibond
        - renormalization 
    - profiling:
	     - benchmark for small systems
        - minimize memory allocation / intermediates?
	     - make sure the code works for Fe4S4 & Fe8S7 with small D 
	     - formulae correctly generated 
        - use input for schd & fname to control whether write *.txt 
    - optimization of onedot & twodot algorithm:
	     - int1e only appears in oper_dot.h
        - remove explicit H() in qt_qt:
	 - revise qt3_qt2 without explicit H() 
        - revise qt4_qt2 without explicit H()
        - preprocess onedot: 
        - avoid memory allocation in sigma (onedot/twodot)
	     - avoid memset?
        - revise renormalization
        - preprocess twodot:
	       - preallocation of workspace
	       - contract_qt4_qt2_info 
    - better data structure? pointer?
	 - vtune profile stackblock for comparison [!!!] 
        - info only store offset or maps: [CRUCIAL PART!!!]
	     - auto& blk3 = qt3(br,bc,bm) - avoid computation!
        - avoid daxpy?
    - low-level implementation of contract without dtensor!
	     - contract_qt3_qt2_info
	     - contract_qt4_qt2_info
	     - contract_qt3_qt3_info
  	 - openmp error due to qt2.conjugate() for complex case [1_lih3_dcg]
	 - conjugate is treated outside contract_opxwf!
    - minimal operation count: bipart_oper with factorization

 * Better IO strategy: [DONE@2022/04/08]
    - oper_stack: global memory for saving oper_load 
    - concurrency: separate computation & save for saving oper_save
    - remove hdf5 support: compare against iostream (timing)	
    - new computational model:
	   1. fetch qops from memory / disk
	   2. compute [Hx/renorm] + save previous qops [threaded]
	   3. fkept is updated, the old qops will be released
      4. delete unused file at a given bond
    - data compression? 
    - reduce half AB/PQ operators?

 * Distributed H[CS] term - Chan's algorithm [DONE@2022/06/10]
    - renorm opS and opH
    - twodot partition
    - onedot partition
    - hdiag for ifdist1
   
 * Load balance: [DONE@2022/06/15]
    - better distribution of operators 
    - opS? currently this is not good because a*Ac type operators 
    - Hx? typical: cN [isym=1, ifkr=False]
		   cNSz [isym=2, ifkr=False]
		   cNK [isym=1, ifkr=True]

 * Restart from optimized states:
    - task_dmrg & lastdot
    - change the name of the file rcanon_new.info to avoid overwrite later
    - if the operator files are not deleted:
	      task_opt & rcanon_load & rcanon_file newname.info
      else rebuild the operators
	      task_dmrg & rcanon_load & rcanon_file newname.info

 * Better sweep performances [DONE@2022/07/14]
    - Reducing the number of Hx in Davidson solver
    - tuning size of subspace & preconditioning
    - nbuff>=4 (larger value does not matter too much); keep 2 delU for restart!
	 - LOBPCG like improvement 
    - Sweep decimation:
        - only perform decimation for 4*ksupp >= Dcut, hence boundary sites are 
          almost exact, unless some quantum numbers are missing from the start.
        - exact sites for cNK also work!
 
 * More abstract implementation: preparation for GPU
    - Basics [DONE@2022/06/25]
       1. AXPY: form summed operators (form intermediates)
       2. GEMM: contract and accumulate
       3. MMlist & cost analysis
    - Twodot Hx [DONE@2022/06/27]
    - Onedot Hx [DONE@2022/06/27]

### 2023 DMRG[GPU] ###

 * Better reduction algorithm using GEMV [DONE@2023/03/01]

 * Test platform on jiageng: [DONE@2023/03/01]
    - Add more tests in examples 
    - Muilt-GPU support on jiageng? => reinstall OpenMPI
    - Profiling: Check fetch time & CPU memory for Fe8S7!

 * Problems for large arrays: [DONE@2023/03/07] 
    - Fix bug in GPU implementation - wrong results sometimes? [DONE@20230227 magmamemcpy size is int]
    - MPI: bypass the 2GB limit in MPI_COUNT by partitioned broadcast & reduce
    - MATH: Fix int32 & int64 problem in blas/lapack using MKL_INT [ndim is int]
    - zquatev: resolve cNK bugs? use MKL_INT

 * Support restart isweep & ibond: [DONE@2023/03/09]
    0. restructure rsites/lsites/rwfuns/psi into sites/rwfuns/psi - more compact 
       - rwfuns must be used, otherwise get_Hmat will not work in CNK in the last site !!!
    1. fix guess error 
    2. fix last conversion into RCF 
    3. add dump RCF at each step 
    4. support restart by loading RCF
    5. support restart at a particular ibond

 * Batch support: [DONE@2023/03/24]
    - Support Intermediate with batch
         0. fix storage order in oper_dict to make opC contigous
         1. consistent ordering for dgemv? 
    - Support Renorm with batch
         0. basic subroutines: alg_renorm=4 
            - preprocess_renorm.h
            - preprocess_rformulae.h
            - preprocess_rinter.h
            - preprocess_rlist.h
            - preprocess_rmu.h
         1. alg_renorm=16: CPU batch 
            - preprocess_rmmtasks.h
            - preprocess_rernorm_batch.h
    - Support Intermediate generated on the fly
         0. sigma (alg_hvec=7) 
            - preprocess_sigma_batch2.h
         1. renorm (alg_renorm=17) 
            - preprocess_renorm_batch2.h

 * GPU support for Intermediate & Renorm: [DONE@2023/03/27]
    - Support Intermediate with GPU:
          0. alg_inter=2: GPU batch 
    - Support Renorm with GPU:
          0. alg_hvec=16/17: GPU batch 
             - preprocess_rernorm_batchGPU.h
          1. alg_renorm=16/17: GPU batch 
             - preprocess_rernorm_batchGPU.h
    - Single batch: 18/19

 * Profiling: better timing for alg_hvec & alg_renorm [DONE@2023/04/01]
    - single batch: alg_hvec=17/19
    - mmorder [no significant difference]
    - ifdist1?

 * async IO strategy: bugfix [DONE@2023/05/18]
    - revise GPUmem control 
    - revise oper_pool
    - revise sweep_twodot/onedot_renorm to release unnecessary operators before renorm to save memory
    - overlap save operators with computation? 
    - overlap fetch operators with computation? 
    - hdiag implementation on GPU 
    - async memcpy to GPU => magma_queue

 * parallel decimation:
    - openmp + mpi [DONE@2023/04/23]
    - mpi -> share memory?
    - GPU version for large D>5000? [DONE@2023/??/??]

 * cpu<->gpu, network communication: 
    1. reduce in Davidson: first reduce within node - NCCL? see core/mpi_wrapper.h [DONE@2023/04/17]
    2. perform renormalization by class [CABPQSH, hiden memcpy]

 * More balanced partition of rops and Hx? scale up to more nodes?
    - better treatment of opS term for DMRG, assuming Cop are distributed [DONE@2023/05/01]
    - formulae based partition

 * Better treatment GEMM involving 'c': use axpy_vbatch?
    - REMOVE c related for NSz symmetry [DONE@2023/05/18]
    - unrool for N symmetry
    - general treatment for A[M,K]*B[K,N] for small K,N (~1,2,...,dbranch)

 * Better GEMM_BATCH with TensorCore: [DONE@2023/05/24]
    - cublas dgemmbatched 

 * Exact diagonalization by construct full Hamtiltonian [DONE@2023/01/17]

### 2023 VMC [unifinished] ###

 * VMC + iRBM:
    - opt_exact [DONE@2023/01/13]
    - various RBM ansatz [DONE@2023/01/14]
    - stochastic reconfiguration (SR): SVD-based?
    - opt_sample: MCMC
    - schedule for nhiden?
    - pretraining by SCI
    - iron-sulfur clusters: frustrated spin systems

### 2023 postCTNS [unfinished] ###

 * postCTNS.x driver: interface MPS: [DONE@2023/06/30]
    - overlap between two MPS? 
    - Sdiag: fast sampling 
    - expectation value via sampling:
       - <Psi|H|Psi>
       - <Psi|S2|Psi> 
       - <Psi|(H-E)^2|Psi>
    - spin-projection:
       - small d function 
       - Gauss-legendre points 
       - matrix elements for exp[-i*beta*Sy] 
       - <Psi|Ps|Psi> (lower sym: xNSz->xN => IMPORTANT) 
       - E[P|psi>] = <Psi|HPs|Psi>/<Psi|Ps|Psi> 
       - error for <Psi|Ps|Psi> at Smax? <Psi|Ps|Psi> >= 0
    - optimization for VMC energy
       - faster <n|Psi> functions [!!!]
    - parallelization:
       - parallel random number generator (PRNG)
       - MPI+OpenMP
       - GPU?
    - VMC algorithm:
       - RBM with libtorch?
       - RBM on top of MPS?

### 2024 DMRG[SA] ###

 * driver & makefile: sadmrg [DONE@2024/01/12]

 * data structure for tensors & comb: [DONE@2024/01/16]
    - switch between different implementation depending on Abelian or not [!!!]
       (1) std::conditional<Qm::ifabelian, stensor2<Tm>, stensor2su2<Tm>>::type in comb 
       (2) template <bool y=ifab, std::enable_if_t<y,int> = 0> in qtensor2 
    - tensor with non-abelian symmetry
       (1) qinfoNsu2 (N is rank)
       (2) stensorNsu2

 * generate initial guess by conversion: [DONE@2024/01/27]
    - tosu2: conversion to su2  
       - data structures: Wmat, MixedSite, density matrix [DONE@2024/01/21]
       - cg couling: gsl (GNU Scientific Library) 
       - sweep projection [DONE@2024/01/23]
       - check thresh_su2 [DONE@2024/01/25]
       - expand Yinfo into MPS site [DONE@2024/01/27]

 * MPS algebra: ctns_alg.h [DONE@2024/03/04]
    - rcanon_check [DONE@2024/02/04]
    - overlap: get_Smat [DONE@2024/02/04]
    - CSF related data structure [DONE@2024/02/28]
    - ctns_csf2samps.h [DONE@2024/02/28]
    - ctns_expand.h & ctns_cicoeff.h [DONE@2024/03/03]
    - ctns_sample.h & ctns_sdiag.h [DONE@2024/03/04]
       - sample CSF? 
       - sample DET? 

 * get Hamiltonian: [DONE@2024/04/01]
    - oper_env_right: prepare environment operators
       - oper_dict.h: data structure {c,A,B,P,Q,S}
          - qnum_qsym.h: get_sym_opX
          - oper_pool.h: support su2 tensor [DONE@2024/03/09]
       - oper_dot_su2.h: [DONE@2024/03/10]
       - oper_renorm.h: KEY STEP [!!!]
          - symbolic_formulae_renorm_su2: how to encode info about intermediate spins
             - symbolic_normxwf_su2:
             - symbolic_compxwf_su2: COMPLICATED PART ! [DONE@2024/03/12]
          - intermediates: rinter.init() [DONE@2024/03/14]
          - preprocess_formulae_Rlist.h
          - preprocess_rmu.h [DONE@2024/03/15]
          - Rmmtasks[i].init()
          - preprocess_renorm_batchDirectSingle()
    - convert su2mps to non-spin-adapted MPS? 
       - to_nonsu2 [DONE@2024/03/28]
       - debug Hij & correctness of the generated formula 
       - opS is the most complicated [DONE@2024/03/29] 

 * Spin-adapted DMRG algorithm: twodot [DONE@2024/04/02]
    - twodot sweep algorithm
       - symbolic_formulae_twodot_su2: [DONE@2024/03/13]
       - restructure the code the reuse more subroutines
       - preprocess_hmu.h [DONE@2024/03/14]
    - twodot_diag: checked use guess=0 & cisolver=0
    - renorm: sweep_twodot_renorm_su2.h
       - reshape_qt4_qt3_su2.h: turns out to be extremely simple based on existing code! [DONE@2024/04/01]
       - reshape_qt3_qt2_su2.h
       - sweep_twodot_decim_su2.h: basic version checked with notrunc option! [DONE@2024/04/02]
    - decimation with truncation:
       - sweep_decim_su2.h: simple version [DONE@2024/04/02]
 
 * Other important functionalities: [DONE@2024/04/03]
    - propagation of initial guess
       - recouple for qt3: [DONE@2024/04/02]
       - sweep_twodot_guess.h: revised by adding recoupling
    - initialize guess for start
       - sweep_init: [DONE@2024/04/02]
    - canonicalization:
       - sweep_rcanon.h: [DONE@2024/04/02]
    - singlet embedding:
       - sweep_init & get_left_bsite: [DONE@2024/04/03]
       - change operators: oper_dot_su2.h [DONE@2024/04/03]
       - sweep_final: [DONE@2024/04/03]
    - twodot_diag_GPU: [DONE@2024/04/07]

 * Careful check different implementations: [DONE@2024/04/06]
    - MPI:
       - bugfix for ifdist1
       - bugfix for blksize==0
    - OpenMP:
       - bugfix for 1_lih_dcg? Due to linking to both gomp&iomp via magma.
                               The compiler for magam must be the same!!!
 
 * Spin-adapted DMRG algorithm: sweep_onedot.h [DONE@2024/05/13]
    - non-spin-adapted case:
       - alg_hvec=4 & alg_hvec=5 [DONE@2024/05/04]
          - preprocess_hmu.h
       - alg_hvec=6,7,8,9 [DONE@2024/05/04]
          - preprocess_hmmtask.h
       - alg_hvec=16,17,18,19 [DONE@2024/05/07]
          - sweep_onedot_diagGPU.h
          - gpu_kernel/onedot_diagGPU_kernel.*
    - use function class for HVec [DONE@2024/05/10]
       - twodot & onedot abstraction 
       - better timing for dvdson 
       - async IO for onedot case
    - spin-adapted case: simply start from cisolver=0 & guess=0 to check Hij & Diag: [DONE@2024/05/11] 
       - symbolic_formulae_onedot_su2.h [DONE@2024/05/11]
       - preprocess_hmu.h for spin-adapted case: l|cr or lc|r [DONE@2024/05/11]
       - onedot_diag: 
          - onedot_diag_su2.h: 
       - onedot_renorm:
          - onedot_decimation:
       - propagation of initial guess & finalization?
          - onedot_guess_psi: turn out to be extremely simple, e.g., recouple_cr().merge_cr()
       - gpu version: [DONE@2024/05/12] 
          - onedot_diagGPU_su2.h:

### 2024 DMRG[OO] ###

 * Orbital-optimized DMRG: output configurations for quantum computing! [DONE@2024/08/29]
    - non-spin-adapted: [DONE@2024/08/12]
      - driver [DONE@2024/07/29]
      - disentangle 
         - entropy functions [DONE@2024/07/30]
         - reduce_entropy
           - canonicalization loop [DONE@2024/07/31]
           - apply Urot to twodot wavefunction? [DONE@2024/08/01] 
           - reduce_entropy via nlopt [DONE@2024/08/02]
         - apply random layer by randomizing theta [DONE@2024/08/03]
      - correct combination of rotated MPS with rotated integrals [DONE@2024/08/12]
      - export output such as mps and integrals?
         - urot.txt
         - rmole_info.new   
      - mpi implementation for large-scale application [DONE@2024/08/12]
    - oodmrg support su2 mps: [DONE@2024/08/24]
      - improvements related with CSF: csf to samps to nsamps [DONE@2024/08/21]
      - support for singlet embedding in computing entropy [DONE@2024/08/22]
         - a task support for computing the entropy for given MPS
      - apply urot to a su2 twodot wavefunction (most complicated step) [DONE@2024/08/22]
         - can this be done analytically without invoking recoupling explicitly? Yes!
      - rcanon_lastdots: to make mps in canonical form, where the last dot is identity.
      - bugfix for samps: 
        - mpi error for oosadmrg due to problem in qinfo
        - oosadmrg for hchain? bug in W-coefficient
        - update urot should based on actual orbital indices to be consistent with integrals,
          rather than the site index only. => This leads to failure in topo!=natural topo.
    - settings: initial and final oodmrg do not change orbital

 * Documentation [DONE@2024/08/26]
    - initial commit

 * More robust initialization from dets, and canonicalization [DONE@2024/09/02]
    - initialization from SCI: support more than 100000 dets [DONE@2024/08/30]
      - fix the loose of orthogonality via canonicalization (ctns_rcanon.h)
    - support linear combination of dets and csf states [DONE@2024/09/02]
      - keyword: fromconf, saveconfs, loadconfs
      - addition of MPS and then canonicalization for nonsu2 case
      - addition of MPS and then canonicalization for su2 case
      - This is efficient for generating a RCF with < 1000 dets/csf,
        which can be used for later optimization or other purpose.

### 2024 DMRG[RDM] ###

 * Properties for post-CI/DMRG calculations:
   - Wish list:
      - Overlap of two MPS? <MPS1|MPS2>
      - 1-RDM: <MPS1|p^+q|MPS2> -> <Epq>, <Tpq>
      - 2-RDM: <MPS1|p^+q^+rs|MPS2> (p>q,r<s) => MOST IMPORTANT [!!!]
      - <MPS1|H|MPS2>
   - Possible applications:
      - Natural orbitals
      - RDM-based orbital optimization (CASSCF, QIO, ...) 
      - Spin-spin correlation function (RDM)
      - Other measures of electron correlation? Shee's work?							
 
 * Use SCI to prepare benchmark! [DONE@2024/09/02]
   - Applied to FeMoco

 * Implementation of RDM for MPS:
   - keyword: savebin & task_prop
   - overlap [DONE@2024/09/02]
   - reference data: brute-force RDM & TDM algorithm for nonsu2 case [DONE@2024/06/02]
      - Apply local op to MPS:
      - Contract <bMPS|kMPS> to get RDM/TDM
      - quantum information measure:
         - single orbital entropy [or just from 1,2-RDMs]

 * RDMs for nonsu2 case [DONE@2024/09/12]
   - generation of patterns
   - propagation of wavefunction: loop structure using onedot [DONE@2024/09/04]
   - is_same=true: RDM [DONE@2024/09/06]
      - propagation of operators [DONE@2024/09/04]
         - rdm_env
         - support Id in dot and oper_dict [DONE@2024/09/05] 
         - support Id in renorm 
         - support local operators in renorm
      - reference implementation alg_rdm=0
         - compute rdm1 [DONE@2024/09/05] 
         - assemble rdm1
         - compute rdm2
            - treatment of |+-|
            - support ifhermi in dot
         - assemble rdm2: simple version [DONE@2024/09/06]
         - is_same: reduction of patterns
         - check Hij
   - is_same=false: TDM [DONE@2024/09/07]
      - rdm1 [DONE@2024/09/06]
         - support D operators 
      - rdm2 [DONE@2024/09/07]
         - support {D,M} dot operators 
         - support {D,M} in renorm
         - rethinking about whether patterns is "-+" needed? no if all opB are kept
   - optimized parallel CPU version for alg_rdm:
      - MPI (reduction of rdm)
         - driver [DONE@2024/09/08]
         - partition of workload to avoid redundant calculations [DONE@2024/09/09]
      - OpenMP for the left operators [DONE@2024/09/09]
      - add timing for each pattern and all
      - Note: rdm1 for femoco does not match rdm from SCI (because converting two states are not perfectly done)
         - problem can be resolved by using very small thresh_proj=1.e-18
   - rdm_renorm support other options for alg_renorm (including GPU support)
      - add identity for formulae in nonsu2 case, which becomes consistent with su2 case.
        However, identity operator does not allowed to have coefficient. This will simplify coding,
        because we can simpy skip it.
      - symbolic formulae support for {I,C,D,A,B,M}
      - check correctness of oper_renorm & rdm_renorm by etot and tdm
         - alg_renorm = 0       DONE          DONE
         - alg_renorm = 1       DONE          DONE
         - alg_renorm = 2       DONE          ---- [not supported]
         - alg_renorm = 3       ----          ----
         - alg_renorm = 4       DONE          DONE [memory usage can be optimized]
         - alg_renorm = 5       ----          ----
         - alg_renorm = 6-9     DONE          DONE
         - alg_renorm = 16-19   DONE          DONE
      - sweep_hvec
         - alg_hvec = 0         DONE
         - alg_hvec = 1         DONE
         - alg_hvec = 2         DONE
         - alg_hvec = 3         DONE
         - alg_hvec = 4         DONE
         - alg_hvec = 5         DONE
         - alg_hvec = 6-9       DONE
         - alg_hvec = 16-19     DONE
   - single site entropy via rdm [DONE@2024/09/12] 

 * RDMs for su2 case:
   - su2 dot operators {I,D,M,T,F} [DONE@2024/09/12]
      - oper_dot_su2.h
   - rdm_renorm: support su2 operators{I,D,M }
   - is_same=true:
      - rdm1
         - assemble?
         - spin recoupling?
======================================================================
Before ISTCP: Correct spin-averaged RDM1 for su2 case for NatOrbs ?
======================================================================
      - rdm2
   - is_same=false:
      - rdm1
      - rdm2

