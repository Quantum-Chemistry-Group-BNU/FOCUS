
## eigen
#MATH = -I /usr/local/include/eigen3 -DEIGEN_USE_BLAS -DEIGEN_USE_LAPACKE \
       -L./libmkl -Wl,-rpath,./libmkl -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lpthread -lm -ldl

## serial version of MKL
#MATH = -L./libmkl -Wl,-rpath,./libmkl -lmkl_intel_lp64 -lmkl_core -lmkl_sequential -lpthread -lm -ldl

# parallel version of MKL
#MATH = -L/Users/zhendongli/anaconda2/envs/py36/lib -Wl,-rpath,/Users/zhendongli/anaconda2/envs/py36/lib \
#       -lmkl_intel_lp64 -lmkl_core -lmkl_intel_thread -lpthread -lm -ldl \
#       -L./extlibs/zquatev -lzquatev
MATH =  -L/opt/intel/compilers_and_libraries_2020.4.304/linux/mkl/lib/intel64 \
	-lmkl_intel_lp64 -lmkl_core -lmkl_intel_thread -lpthread -lm -ldl \
	-liomp5 \
	-L./extlibs/zquatev -lzquatev 

# mac framework Accelerate
#MATH = -llapack -lblas

BOOST = /home/lx/software/boost/install_1_59_0

USE_GCC = no #yes
USE_MPI = no
ifeq ($(USE_MPI), yes) 
   CXX = mpig++
   CC = mpigcc
   LFLAGS += ${MATH} -L${BOOST}/lib -lboost_serialization-mt -lboost_mpi-mt #-lrt
else
   ifeq ($(USE_GCC), yes)
      CXX = g++
      CC = gcc
      FLAGS = -fopenmp -DGNU -DNDEBUG -std=c++11 -g -O2 -Wall -I${BOOST}/include ${INCLUDE_DIR} 
   else
      CXX = icpc
      CC = icc
      FLAGS = -qopenmp -std=c++11 -g -O2 -Wall -I${BOOST}/include ${INCLUDE_DIR} 
   endif
   LFLAGS = ${MATH} -L${BOOST}/lib -lboost_serialization-mt -lboost_system-mt -lboost_filesystem-mt 	
endif

SRC = src
BIN_DIR = ./bin
OBJ_DIR = ./obj

# all dependence
SRC_DIR1 = ./$(SRC)/tests
SRC_DIR2 = ./$(SRC)/io
SRC_DIR3 = ./$(SRC)/core
SRC_DIR4 = ./$(SRC)/ci
SRC_DIR5 = ./$(SRC)/tns
SRC_DIR6 = ./$(SRC)/ctns
INCLUDE_DIR = -I$(SRC_DIR1) \
	      -I$(SRC_DIR2) \
	      -I$(SRC_DIR3) \
	      -I$(SRC_DIR4) \
	      -I$(SRC_DIR5) \
	      -I$(SRC_DIR6) \
	      -I./extlibs/zquatev
SRC_DEP = $(wildcard $(SRC_DIR1)/*.cpp \
	  	     $(SRC_DIR2)/*.cpp \
	  	     $(SRC_DIR3)/*.cpp \
	  	     $(SRC_DIR4)/*.cpp \
	  	     $(SRC_DIR5)/*.cpp \
	  	     $(SRC_DIR6)/*.cpp)
OBJ_DEP = $(patsubst %.cpp,$(OBJ_DIR)/%.o,$(notdir ${SRC_DEP}))

# all the files with main functions
SRC_ALL = $(SRC_DEP) 
SRC_ALL += $(wildcard ./$(SRC)/drivers/*.cpp)
OBJ_ALL = $(patsubst %.cpp,$(OBJ_DIR)/%.o,$(notdir ${SRC_ALL}))

all: depend \
     $(BIN_DIR)/tests.x \
     $(BIN_DIR)/tns.x \
     $(BIN_DIR)/ctns.x

depend:
	set -e; \
	mkdir -p $(BIN_DIR) $(OBJ_DIR); \
	echo $(SRC_ALL); \
	$(CXX) -I${BOOST}/include -MM $(SRC_ALL) > $$$$.depend; \
	echo 'done'; \
	sed 's,\([^.]*\.o\),$(OBJ_DIR)/\1,' < $$$$.depend > .depend; \
	echo 'finish dependency check!'; \
	rm -f $$$$.depend # $$$$ id number 
-include .depend

$(BIN_DIR)/tests.x: $(OBJ_DIR)/main_tests.o $(OBJ_DEP)
	@echo "\n=== LINK $@"
	@echo $(OBJ_DEP)
	$(CXX) $(FLAGS) -o $@ $^ $(LFLAGS)

$(BIN_DIR)/tns.x: $(OBJ_DIR)/main_tns.o $(OBJ_DEP)
	@echo "\n=== LINK $@"
	@echo $(OBJ_DEP)
	$(CXX) $(FLAGS) -o $@ $^ $(LFLAGS)

$(BIN_DIR)/ctns.x: $(OBJ_DIR)/main_ctns.o $(OBJ_DEP)
	@echo "\n=== LINK $@"
	@echo $(OBJ_DEP)
	$(CXX) $(FLAGS) -o $@ $^ $(LFLAGS) 

$(OBJ_ALL):
	@echo "=== COMPILE $@ FROM $<" # just from *.cpp is sufficient
	$(CXX) $(FLAGS) -o $@ -c $< 

clean:
	rm .depend
	rm -f obj/*.o
	rm -f bin/*.x
